<form *ngIf="workflow">
	<div class="row mb-2">
		<label for="workflowNameInput" class="col-2 col-form-label">Name</label>
		<div class="col-10">
			<input id="name" name="name" type="text" size="10" maxlength="50" class="form-control"
				[(ngModel)]="workflow.name" autocomplete="off" required>
		</div>
	</div>
	<div class="row mb-2">
		<label for="description" class="col-2 col-form-label">Description</label>
		<div class="col-10">
			<textarea id="description" name="description" type="text" style="height: 100px;" class="form-control" [(ngModel)]="workflow.description"
				autocomplete="off" required></textarea>
		</div>
	</div>
</form>

<div class="canvas-container mb-2" (mousemove)="onMouseMove($event)" (mouseup)="cancelConnection()">

	<div class="m-2 task-list-column d-flex flex-column" style="flex: 0 0 250px">
		<ng-container *ngIf="editTask; else noEdit">
			<div class="flex-shrink-0">
				<h3>Edit Task</h3>
				<button type="button" class="btn btn-primary me-2" (click)="doneEditingStep()">Done</button>
				<button type="button" class="btn btn-danger float-end" (click)="deleteStep()">Delete Task</button>
			</div>
			<form class="flex-grow-1 overflow-auto">
				<minty-task-editor name="{{editTask.stepName}}-editor"
						[(ngModel)]="editTask"
						[taskSpecification]="specFor(editTask)"
						[defaults]="defaultsFor(editTask)"
						[enumLists]="enumLists"
						[models]="models"
						(taskNameChanged)="onStepNameChanged($event)"></minty-task-editor>
			</form>
		</ng-container>
		<ng-template #noEdit>
			<h3>Add Task</h3>
			<div class="accordion" id="task-accordion">
				<div class="accordion-item" *ngFor="let group of specGroups">
					<div class="accordion-header">
						<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" [attr.data-bs-target]="'#' + getEscapedGroupId(group) + '-collapse'">
							{{group}} Tasks
						</button>
					</div>
					<div [id]="getEscapedGroupId(group) + '-collapse'" class="accordion-collapse collapse" data-bs-parent="#task-accordion">
						<ul class="list-group">
							<ng-container *ngFor="let spec of sortandFilterSpecifications(group, taskSpecifications)">
								<li class="list-group-item">
									<span class="text-truncate clickable-text" (click)="addStep(spec)">
										{{spec.taskName}}
									</span>
								</li>
							</ng-container>
						</ul>
					</div>
				</div>
				<div class="accordion-item">
					<div class="accordion-header">
						<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#output-collapse">
							Output Tasks
						</button>
					</div>
					<div id="output-collapse" class="accordion-collapse collapse" data-bs-parent="#task-accordion">
						<ul class="list-group">
							<ng-container *ngFor="let spec of sortandFilterSpecifications(group, outputTaskSpecifications)">
								<li class="list-group-item">
									<span class="text-truncate clickable-text" (click)="addOutputStep(spec)">
										{{spec.taskName}}
									</span>
								</li>
							</ng-container>
						</ul>
					</div>
				</div>
			</div>
		</ng-template>
	</div>

	<!-- Canvas -->
	<div #canvas class="canvas border border-success rounded flex-grow-1 flex-fill overflow-auto">
		<!-- SVG for connections -->
		<svg class="connections">
			<!-- Existing connections -->
			<path *ngFor="let c of workflow?.connections" [attr.d]="getConnectionPoints(c).d"
				[attr.stroke]="getConnectionPoints(c).isStraight ? 'black' : 'black'" stroke-width="2"
				fill="none" (click)="onConnectorClicked(c)">
			</path>

			<!-- Temporary connection (drag‑and‑drop) -->
			<line *ngIf="tempConnection" [attr.x1]="tempConnection.fromX" [attr.y1]="tempConnection.fromY"
				[attr.x2]="tempConnection.toX" [attr.y2]="tempConnection.toY" stroke="gray" stroke-width="2"
				stroke-dasharray="5,5">
			</line>
		</svg>


		<!-- Canvas elements -->
		<minty-task-widget [task]="step" *ngFor="let step of workflow?.steps ; trackBy: trackStepById" cdkDrag cdkDragBoundary=".canvas"
			(cdkDragMoved)="onDragMoved($event, step)" (cdkDragEnded)="onDragEnded($event, step)"
			[cdkDragFreeDragPosition]="{ x: step.layout.x, y: step.layout.y }"
			[id]="step.stepName"
			(displayTask)="onDisplayTask(step.id)"
			(startConnection)="onStartConnection(step, $event)"
			(endConnection)="onEndConnection(step, $event)"
			(hoverPort)="onHoverPort(step, $event)"></minty-task-widget>

		<ng-container *ngIf="workflow?.outputStep">
			<minty-task-widget [task]="workflow.outputStep" cdkDrag cdkDragBoundary=".canvas"
				(cdkDragMoved)="onDragMoved($event, workflow.outputStep)" (cdkDragEnded)="onDragEnded($event, workflow.outputStep)"
				[cdkDragFreeDragPosition]="{ x: workflow.outputStep.layout.x, y: workflow.outputStep.layout.y }"
				[id]="workflow.outputStep.stepName"
				(displayTask)="onDisplayTask(workflow.outputStep.id)"
				(startConnection)="onStartConnection(workflow.outputStep, $event)"
				(endConnection)="onEndConnection(workflow.outputStep, $event)"
				(hoverPort)="onHoverPort(workflow.outputStep, $event)"></minty-task-widget>
		</ng-container>

	</div>
</div>
<minty-confirmation-dialog [title]="'Delete Step'" [message]="'Are you sure you want to delete this step?'"
	[visible]="confirmDeleteStepVisible" (confirm)="confirmDeleteStep()"
	(cancel)="confirmDeleteStepVisible = false"></minty-confirmation-dialog>