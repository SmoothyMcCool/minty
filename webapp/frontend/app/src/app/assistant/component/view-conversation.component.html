<div>
	<div class="container">
		<h1>{{assistant.name}}<ng-container *ngIf="conversation && conversation.title"> -
				{{conversation.title}}</ng-container></h1>

		<div class="overflow-auto" *ngIf="user && !newestMessagesFirst">
			<minty-conversation [messages]="chatHistory" [responsePending]="waitingForResponse"
				[queueDepth]="queueDepth" [oldestMessagesFirst]="user && !newestMessagesFirst" [showChatOptions]="showChatOptions"></minty-conversation>
		</div>

		<ng-container *ngIf="sources">
			<div class="row mb-2">
				Sources Used by the last Response (Warning: source information is not preserved!):
			</div>
			<ul class="list-group">
				<li class="list-group-item list-group-item" *ngFor="let source of sources">
					{{source}}
				</li>
			</ul>
		</ng-container>

		<div class="row mb-2" *ngIf="metrics && (metrics.promptTokens > 0 || metrics.completionTokens > 0) ">
			<div class="col-auto">
				<strong>Request Tokens:</strong>&nbsp;{{metrics.promptTokens}}
			</div>
			<div class="col-auto">
				<strong>Response Tokens:</strong>&nbsp;{{metrics.completionTokens}}
			</div>
			<div class="col-auto">
				<strong>Total Tokens:</strong>&nbsp;{{metrics.promptTokens + metrics.completionTokens}}
			</div>
		</div>

		<div class="row mb-2" *ngIf="(assistant.prompt.length > 0 || !assistant.hasMemory) && showChatOptions">
			<div class="col">
				<div class="overflow-auto well p-3" style="white-space: pre-wrap; height: 100px;">
					<div *ngIf="!assistant.hasMemory">
						<i class="bi bi-exclamation-triangle">
							This assistant has no conversation history!
							It will only respond to the last message you send,
							and your conversation will not be saved.
						</i>
					</div>
					{{assistant.prompt}}
				</div>
			</div>
		</div>

		<div class="row mb-2 form-floating">
			<div class="col form-floating">
				<textarea class="form-control" id="aiQuery" name="aiQuery"
					[(ngModel)]="userText" style="max-height: 400px;" autoResize></textarea>
				<label class="ms-3" for="aiQuery">Put your input here</label>
			</div>
		</div>

		<div class="row mb-2" [ngClass]="{ 'flex-row-reverse': reverseButtons }">
			<div class="col-auto">
				<button class="btn btn-primary mb-2" (click)="submit(userText)"
					[disabled]="!userText || waitingForResponse">
					<i class="bi" [class.bi-arrow-down]="newestMessagesFirst" [class.bi-arrow-up]="!newestMessagesFirst"></i>
				</button>
			</div>
			<div class="col">
				<minty-image-input [imageSupport]="model && model.imageSupport" [reset]="shouldReset" (image)="onImageChanged($event)"></minty-image-input>
			</div>
			<div class="col-auto">
				<button class="btn btn-danger" (click)="restartConversation()">
					<i class="bi bi-arrow-counterclockwise"></i>
				</button>
			</div>
			<div class="col-auto">
				<button class="btn" (click)="showChatOptions = !showChatOptions">
					<i class="bi bi-sliders"></i>
				</button>
			</div>
		</div>

		<div class="form-group mb-2" *ngIf="model && showChatOptions">
			<minty-slider [min]="model.defaultContext" [max]="model.maximumContext" [label]="'Context Size (Smaller is sometimes faster)'" [(ngModel)]="contextSize"></minty-slider>
		</div>

		<div class="overflow-auto" *ngIf="user && newestMessagesFirst">
			<minty-conversation [messages]="chatHistory" [responsePending]="waitingForResponse"
				[queueDepth]="queueDepth" [oldestMessagesFirst]="!newestMessagesFirst" [showChatOptions]="showChatOptions"></minty-conversation>
		</div>

	</div>
</div>

<minty-confirmation-dialog [title]="'Restart Conversation'"
	[message]="'Are you sure you want to start over? You conversation history will be irretrievably lost.'"
	[visible]="confirmRestartConversationVisible" (confirm)="confirmRestartConversation()"
	(cancel)="confirmRestartConversationVisible = false">
</minty-confirmation-dialog>